# üóÑÔ∏è Configura√ß√£o do Supabase - Conex√£o Digital Inclusiva

Este documento explica como configurar e usar a integra√ß√£o com o Supabase para armazenar dados de feedback e question√°rios, incluindo sistema de valida√ß√£o robusta e fallback autom√°tico para localStorage.

## üìã Pr√©-requisitos

1. **Conta no Supabase**: Crie uma conta gratuita em [supabase.com](https://supabase.com)
2. **Projeto criado**: Crie um novo projeto no dashboard do Supabase
3. **Credenciais**: Tenha em m√£os a URL do projeto e a chave an√¥nima (anon key)
4. **Navegador moderno**: Suporte a ES6+ e WebGL para funcionalidades avan√ßadas

## üîß Configura√ß√£o Inicial

### 1. Criar as Tabelas no Supabase (Atualizado)

Execute o script SQL atualizado no SQL Editor do Supabase:

1. Acesse o Dashboard do Supabase
2. V√° para **SQL Editor**
3. Cole o script abaixo e execute:

```sql
-- Tabela para feedback geral (estrutura atualizada)
CREATE TABLE feedback (
    id BIGSERIAL PRIMARY KEY,
    name TEXT DEFAULT 'An√¥nimo',
    email TEXT,
    type TEXT NOT NULL,
    message TEXT NOT NULL,
    rating INTEGER CHECK (rating >= 1 AND rating <= 5),
    page TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Tabela para question√°rios de acessibilidade (estrutura atualizada)
CREATE TABLE questionnaires (
    id BIGSERIAL PRIMARY KEY,
    name TEXT DEFAULT 'An√¥nimo',
    disability_type TEXT,
    assistive_technologies TEXT[],
    common_problems TEXT[],
    site_rating INTEGER CHECK (site_rating >= 1 AND site_rating <= 5),
    suggestions TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Habilitar RLS (Row Level Security)
ALTER TABLE feedback ENABLE ROW LEVEL SECURITY;
ALTER TABLE questionnaires ENABLE ROW LEVEL SECURITY;

-- Pol√≠ticas atualizadas para opera√ß√µes p√∫blicas
CREATE POLICY "Allow public insert" ON feedback FOR INSERT WITH CHECK (true);
CREATE POLICY "Allow public select" ON feedback FOR SELECT USING (true);
CREATE POLICY "Allow public insert" ON questionnaires FOR INSERT WITH CHECK (true);
CREATE POLICY "Allow public select" ON questionnaires FOR SELECT USING (true);

-- √çndices para performance
CREATE INDEX idx_feedback_created_at ON feedback(created_at DESC);
CREATE INDEX idx_questionnaires_created_at ON questionnaires(created_at DESC);
CREATE INDEX idx_feedback_type ON feedback(type);
CREATE INDEX idx_questionnaires_disability ON questionnaires(disability_type);
```

### 2. Configurar as Credenciais

Edite o arquivo `js/supabase-config.js` e atualize as seguintes informa√ß√µes:

```javascript
const SUPABASE_CONFIG = {
    url: 'SUA_URL_DO_SUPABASE_AQUI',
    key: 'SUA_CHAVE_ANONIMA_AQUI',
    // ...
};
```

**Como encontrar suas credenciais:**
1. No Dashboard do Supabase, v√° para **Settings** > **API**
2. Copie a **URL** do projeto
3. Copie a **anon key** (chave p√∫blica)

### 3. Verificar a Integra√ß√£o

Use os arquivos de teste atualizados para verificar a configura√ß√£o:

1. **Teste B√°sico**: Abra `test-supabase.html`
   - Testa conex√£o b√°sica
   - Verifica se as tabelas existem
   - Testa inser√ß√£o de dados

2. **Teste de Valida√ß√£o**: Use os formul√°rios principais
   - Teste com campos vazios (valida√ß√£o)
   - Teste com dados v√°lidos
   - Verifique fallback para localStorage

3. **Verificar Dashboard**: Abra `dashboard.html`
   - Confirme se dados aparecem formatados em PT-BR
   - Teste visualiza√ß√µes 3D e mapas de calor
   - Verifique se estat√≠sticas s√£o calculadas corretamente

4. **Teste Admin**: Abra `admin.html`
   - Visualize dados nas tabelas
   - Teste filtros e busca
   - Exporte dados em CSV

## üèóÔ∏è Estrutura das Tabelas

### Tabela `feedback`

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | BIGSERIAL | ID √∫nico (chave prim√°ria) |
| `name` | TEXT | Nome do usu√°rio (padr√£o: "An√¥nimo") |
| `email` | TEXT | Email do usu√°rio (opcional) |
| `type` | TEXT | Tipo: bug, suggestion, compliment, complaint, accessibility |
| `rating` | INTEGER | Avalia√ß√£o de 1 a 5 estrelas |
| `message` | TEXT | Mensagem do feedback |
| `page` | TEXT | P√°gina onde foi enviado |
| `created_at` | TIMESTAMPTZ | Data/hora de cria√ß√£o |

### Tabela `questionnaires` (Atualizada)

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | BIGSERIAL | ID √∫nico (chave prim√°ria) |
| `name` | TEXT | Nome do respondente (padr√£o: "An√¥nimo") |
| `disability_type` | TEXT | Tipo de defici√™ncia/dificuldade |
| `assistive_technologies` | TEXT[] | Array de tecnologias assistivas utilizadas |
| `common_problems` | TEXT[] | Array de problemas comuns encontrados |
| `site_rating` | INTEGER | Avalia√ß√£o do site de 1 a 5 estrelas |
| `suggestions` | TEXT | Sugest√µes e coment√°rios (opcional) |
| `created_at` | TIMESTAMPTZ | Data/hora de cria√ß√£o |

### Principais Mudan√ßas na Estrutura

- ‚úÖ **Campo `name` opcional**: Padr√£o "An√¥nimo" se n√£o fornecido
- ‚úÖ **Campo `email` opcional**: Removido como obrigat√≥rio
- ‚úÖ **Campo `assistive_technologies`**: Renomeado e melhorado
- ‚úÖ **Campo `suggestions`**: Adicionado para coment√°rios
- ‚úÖ **√çndices de performance**: Para consultas mais r√°pidas
- ‚úÖ **Valida√ß√£o robusta**: Sistema de sanitiza√ß√£o no frontend

## üîí Seguran√ßa e Pol√≠ticas RLS

O sistema usa **Row Level Security (RLS)** para controlar o acesso aos dados:

- ‚úÖ **Inser√ß√£o an√¥nima permitida**: Usu√°rios podem enviar feedback sem autentica√ß√£o
- ‚úÖ **Leitura an√¥nima permitida**: Para gerar estat√≠sticas
- ‚ùå **Edi√ß√£o/exclus√£o negada**: Apenas administradores podem modificar dados

## üîÑ Sistema de Fallback Inteligente

O sistema possui um fallback autom√°tico e inteligente para **localStorage** quando:

- O Supabase n√£o est√° dispon√≠vel ou configurado
- H√° problemas de conectividade de rede
- As credenciais est√£o incorretas ou expiradas
- As tabelas n√£o existem ou est√£o mal configuradas
- A API do Supabase est√° temporariamente indispon√≠vel

**Vantagens do sistema atualizado:**
- ‚úÖ **Fallback autom√°tico**: Detec√ß√£o inteligente de falhas
- ‚úÖ **Valida√ß√£o robusta**: Dados s√£o sempre validados antes do armazenamento
- ‚úÖ **Formata√ß√£o consistente**: PT-BR tanto online quanto offline
- ‚úÖ **Experi√™ncia cont√≠nua**: Usu√°rio n√£o percebe problemas de conectividade
- ‚úÖ **Sincroniza√ß√£o futura**: Preparado para sync quando conex√£o voltar

## üõ°Ô∏è Sistema de Valida√ß√£o Avan√ßado

### Valida√ß√£o de Dados
```javascript
// Exemplo da fun√ß√£o de valida√ß√£o
function validateAndCleanData(data) {
    const cleaned = {};
    
    // Nome: opcional, padr√£o "An√¥nimo"
    cleaned.name = (data.name?.trim() || 'An√¥nimo');
    
    // Email: opcional, valida√ß√£o de formato
    if (data.email?.trim()) {
        cleaned.email = data.email.trim();
    }
    
    // Campos obrigat√≥rios com valida√ß√£o
    if (!data.type?.trim()) {
        throw new Error('Tipo √© obrigat√≥rio');
    }
    cleaned.type = data.type.trim();
    
    // Arrays com sanitiza√ß√£o
    if (Array.isArray(data.common_problems)) {
        cleaned.common_problems = data.common_problems
            .filter(p => p?.trim())
            .map(p => p.trim());
    }
    
    return cleaned;
}
```

## üß™ Testando a Integra√ß√£o

## üß™ Testando a Integra√ß√£o Atualizada

### Testes Dispon√≠veis

1. **Teste B√°sico de Conex√£o**: `test-supabase.html`
   - Verifica conectividade
   - Testa opera√ß√µes CRUD b√°sicas
   - Valida estrutura das tabelas

2. **Teste de Integra√ß√£o**: `test-integration.html`
   - Testa formul√°rios completos
   - Verifica valida√ß√£o de dados
   - Confirma fallback para localStorage

### Diagn√≥stico Automatizado

Execute o seguinte no console do navegador para diagn√≥stico completo:

```javascript
// Verificar configura√ß√£o
console.log('Supabase URL:', SUPABASE_URL);
console.log('Cliente inicializado:', !!supabaseClient);

// Testar conex√£o
async function diagnosticoCompleto() {
    try {
        // Teste de conectividade
        const { data: feedbackTest } = await supabaseClient
            .from('feedback').select('count').limit(1);
        console.log('‚úÖ Tabela feedback acess√≠vel');
        
        const { data: questionnaireTest } = await supabaseClient
            .from('questionnaires').select('count').limit(1);
        console.log('‚úÖ Tabela questionnaires acess√≠vel');
        
        // Teste de inser√ß√£o
        const testData = {
            name: 'Teste Diagn√≥stico',
            type: 'suggestion',
            message: 'Teste de conectividade',
            rating: 5
        };
        
        const { data, error } = await supabaseClient
            .from('feedback').insert([testData]).select();
        
        if (error) throw error;
        console.log('‚úÖ Inser√ß√£o funcionando:', data);
        
        // Limpar teste
        await supabaseClient
            .from('feedback')
            .delete()
            .eq('id', data[0].id);
        console.log('‚úÖ Diagn√≥stico completo - tudo funcionando!');
        
    } catch (error) {
        console.log('‚ùå Erro no diagn√≥stico:', error);
        console.log('üîÑ Sistema usar√° localStorage como fallback');
    }
}

diagnosticoCompleto();
```

1. **Console do Navegador**: Verifique mensagens de log
2. **Dashboard Supabase**: Confirme se os dados est√£o sendo salvos
3. **Rede**: Use as ferramentas de desenvolvedor para monitorar requests

### Indicadores de Status

| Emoji | Status | Descri√ß√£o |
|-------|--------|-----------|
| ‚úÖ | Sucesso | Conex√£o funcionando, dados no Supabase |
| ‚ö†Ô∏è | Fallback | Usando localStorage, sem conex√£o |
| ‚ùå | Erro | Problema que precisa ser resolvido |

## üîß Solu√ß√£o de Problemas

### Erro: "Tabela n√£o encontrada"

**Causa**: Tabelas n√£o foram criadas no Supabase
**Solu√ß√£o**: Execute o script `supabase-tables.sql`

### Erro: "401 Unauthorized"

**Causa**: Credenciais incorretas
**Solu√ß√£o**: Verifique URL e chave an√¥nima no arquivo de configura√ß√£o

### Erro: "PGRST301"

**Causa**: Pol√≠ticas RLS muito restritivas
**Solu√ß√£o**: Verifique as pol√≠ticas de seguran√ßa no Supabase

### Biblioteca n√£o carregada

**Causa**: CDN do Supabase n√£o acess√≠vel
**Solu√ß√£o**: Verifique conex√£o com internet e CDN

## üìä Monitoramento

### Logs Importantes Atualizados

```javascript
// Inicializa√ß√£o bem-sucedida
'‚úÖ Cliente Supabase inicializado com sucesso'
'‚úÖ Conex√£o Supabase estabelecida'
'‚úÖ Valida√ß√£o de dados aprovada'

// Sistema de fallback
'‚ö†Ô∏è Supabase indispon√≠vel - ativando fallback para localStorage'
'üì± Dados salvos no localStorage como backup'
'üîÑ Tentativa de reconex√£o agendada'

// Valida√ß√£o de dados
'‚úÖ Dados validados e sanitizados'
'‚ö†Ô∏è Campo obrigat√≥rio preenchido automaticamente'
'‚ùå Erro de valida√ß√£o: campo obrigat√≥rio ausente'

// Formata√ß√£o PT-BR
'üáßüá∑ Dados formatados para portugu√™s brasileiro'
'üìä Dashboard atualizado com dados traduzidos'
```

### Performance e Otimiza√ß√£o

```javascript
// M√©tricas de performance
'‚ö° Query executada em 150ms'
'üíæ Cache atualizado: 50 registros'
'üéØ √çndice utilizado: idx_feedback_created_at'
'üìà Taxa de sucesso: 99.5%'
```

### Eventos Customizados

O sistema dispara eventos que voc√™ pode escutar:

```javascript
window.addEventListener('supabaseReady', function(event) {
    const { connected, source } = event.detail;
    console.log(`Supabase ready: ${connected ? 'connected' : 'fallback'}`);
});
```

## üöÄ Pr√≥ximos Passos e Melhorias

### ‚úÖ **Implementado**
- [x] Sistema de valida√ß√£o robusta com sanitiza√ß√£o
- [x] Fallback inteligente para localStorage 
- [x] Formata√ß√£o completa em portugu√™s brasileiro
- [x] Dashboard com computa√ß√£o gr√°fica (Three.js, D3.js)
- [x] Painel administrativo com dados reais
- [x] Exporta√ß√£o de dados em CSV formatado
- [x] √çndices de performance no banco de dados

### üîÑ **Em Desenvolvimento**
1. **Sincroniza√ß√£o offline/online**: Sync autom√°tica quando conex√£o voltar
2. **Cache inteligente**: Sistema de cache com TTL configur√°vel
3. **Compress√£o de dados**: Otimiza√ß√£o de payload para mobile
4. **Rate limiting**: Prote√ß√£o contra spam e abuso

### üéØ **Pr√≥ximas Funcionalidades**
1. **Notifica√ß√µes em tempo real**: WebSockets para updates instant√¢neos
2. **Backup autom√°tico**: Exporta√ß√£o programada para m√∫ltiplos formatos
3. **Analytics avan√ßadas**: Machine learning para insights autom√°ticos
4. **API p√∫blica**: Endpoints REST para integra√ß√£o externa

### üîß **Configura√ß√µes Avan√ßadas**

#### Otimiza√ß√£o de Performance
```javascript
// Configura√ß√µes recomendadas em js/supabase-config.js
const SUPABASE_CONFIG = {
    url: 'sua-url',
    key: 'sua-chave',
    options: {
        db: {
            schema: 'public',
        },
        auth: {
            autoRefreshToken: false,
            persistSession: false
        },
        global: {
            headers: {
                'x-client-info': 'conexao-digital-v2'
            }
        }
    }
};
```

#### Monitoramento Avan√ßado
```javascript
// Sistema de m√©tricas personalizado
window.addEventListener('supabaseMetrics', function(event) {
    const { operation, duration, success, fallback } = event.detail;
    console.log(`üìä ${operation}: ${duration}ms - ${success ? '‚úÖ' : '‚ùå'} ${fallback ? '(fallback)' : ''}`);
});
```

---